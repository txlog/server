{{ template "header.html" . }}
<div class="page-header d-print-none text-white">
  <div class="container-xl">
    <div class="row g-2 align-items-center">
      <div class="col">
        <div class="page-pretitle">Analytics</div>
        <h2 class="page-title">{{ .title }}</h2>
        <p class="text-white-50 mt-1 mb-0">Compare installed packages across multiple assets to identify configuration
          drift, version differences, and unique packages.</p>
      </div>
    </div>
  </div>
</div>

<div class="page-body">
  <div class="container-xl">
    <div class="row row-deck row-cards">
      <div class="col-12">
        <div class="card">
          <div class="card-header">
            <h3 class="card-title">Select Assets to Compare</h3>
          </div>
          <div class="card-body">
            <p class="text-secondary mb-3">Select 2 to 20 assets to compare their installed packages.</p>
            <div class="row mb-3">
              <div class="col-md-6">
                <label class="form-label">Available Assets</label>
                <select id="available-assets" class="form-select" size="10" multiple>
                  {{ range .assets }}
                  <option value="{{ .MachineID }}" data-hostname="{{ .Hostname }}">{{ .Hostname }}
                  </option>
                  {{ end }}
                </select>
              </div>
              <div class="col-md-1 d-flex flex-column justify-content-center align-items-center gap-2">
                <button type="button" class="btn btn-icon btn-outline-primary" onclick="addSelected()">
                  <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon">
                    <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                    <path d="M9 6l6 6l-6 6" />
                  </svg>
                </button>
                <button type="button" class="btn btn-icon btn-outline-secondary" onclick="removeSelected()">
                  <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon">
                    <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                    <path d="M15 6l-6 6l6 6" />
                  </svg>
                </button>
              </div>
              <div class="col-md-5">
                <label class="form-label">Selected Assets (<span id="selected-count">0</span>/20)</label>
                <select id="selected-assets" class="form-select" size="10" multiple></select>
              </div>
            </div>
            <button type="button" class="btn btn-primary" onclick="comparePackages()" id="compare-btn" disabled>
              <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon">
                <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                <path d="M9 5h-2a2 2 0 0 0 -2 2v12a2 2 0 0 0 2 2h3" />
                <path d="M15 5h2a2 2 0 0 1 2 2v12a2 2 0 0 1 -2 2h-3" />
                <path d="M12 5v14" />
              </svg>
              Compare Packages
            </button>
          </div>
        </div>
      </div>

      <div class="col-12" id="results-section" style="display: none;">
        <div class="card">
          <div class="card-header">
            <h3 class="card-title">Comparison Results</h3>
          </div>
          <div class="card-body" id="results-body">
            <div class="progress progress-sm">
              <div class="progress-bar progress-bar-indeterminate"></div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  const selectedMachineIds = new Map();

  function addSelected() {
    const available = document.getElementById('available-assets');
    const selected = document.getElementById('selected-assets');

    Array.from(available.selectedOptions).forEach(opt => {
      if (selectedMachineIds.size >= 20) return;
      if (!selectedMachineIds.has(opt.value)) {
        selectedMachineIds.set(opt.value, opt.dataset.hostname);
        const newOpt = document.createElement('option');
        newOpt.value = opt.value;
        newOpt.textContent = opt.textContent;
        selected.appendChild(newOpt);
      }
    });
    updateCount();
  }

  function removeSelected() {
    const selected = document.getElementById('selected-assets');
    Array.from(selected.selectedOptions).forEach(opt => {
      selectedMachineIds.delete(opt.value);
      opt.remove();
    });
    updateCount();
  }

  function updateCount() {
    const count = selectedMachineIds.size;
    document.getElementById('selected-count').textContent = count;
    document.getElementById('compare-btn').disabled = count < 2;
  }

  function comparePackages() {
    const machineIds = Array.from(selectedMachineIds.keys()).join(',');
    const resultsSection = document.getElementById('results-section');
    const resultsBody = document.getElementById('results-body');

    resultsSection.style.display = 'block';
    resultsBody.innerHTML = '<div class="progress progress-sm"><div class="progress-bar progress-bar-indeterminate"></div></div>';

    fetch(`/v1/reports/compare-packages?machine_ids=${machineIds}`)
      .then(response => response.json())
      .then(data => {
        if (data.error) {
          resultsBody.innerHTML = `<div class="alert alert-danger">${data.error}</div>`;
          return;
        }

        const commonCount = data.common ? data.common.length : 0;
        const diffCount = data.different ? Object.keys(data.different).length : 0;
        const uniqueCount = data.only_in ? Object.values(data.only_in).reduce((sum, arr) => sum + (arr ? arr.length : 0), 0) : 0;

        let html = '';

        // Summary row
        html += `
                <div class="row mb-4">
                    <div class="col-md-4">
                        <div class="card card-sm bg-success-lt">
                            <div class="card-body">
                                <div class="d-flex align-items-center">
                                    <div class="h1 mb-0 me-3">${commonCount}</div>
                                    <div>
                                        <div class="text-success fw-bold">Common</div>
                                        <div class="text-muted small">Same version on all assets</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card card-sm bg-warning-lt">
                            <div class="card-body">
                                <div class="d-flex align-items-center">
                                    <div class="h1 mb-0 me-3">${diffCount}</div>
                                    <div>
                                        <div class="text-warning fw-bold">Different Versions</div>
                                        <div class="text-muted small">Present but versions differ</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card card-sm bg-info-lt">
                            <div class="card-body">
                                <div class="d-flex align-items-center">
                                    <div class="h1 mb-0 me-3">${uniqueCount}</div>
                                    <div>
                                        <div class="text-info fw-bold">Unique</div>
                                        <div class="text-muted small">Only on specific assets</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>`;

        // Version Differences (most important - show first)
        if (data.different && Object.keys(data.different).length > 0) {
          html += `
                    <div class="card mb-3">
                        <div class="card-header bg-warning-lt">
                            <h3 class="card-title text-warning">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon me-2"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M12 9v4" /><path d="M10.363 3.591l-8.106 13.534a1.914 1.914 0 0 0 1.636 2.871h16.214a1.914 1.914 0 0 0 1.636 -2.87l-8.106 -13.536a1.914 1.914 0 0 0 -3.274 0z" /><path d="M12 16h.01" /></svg>
                                Version Differences (${Object.keys(data.different).length})
                            </h3>
                        </div>
                        <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                            <table class="table table-vcenter card-table table-striped">
                                <thead class="sticky-top bg-white">
                                    <tr>
                                        <th>Package</th>`;
          data.assets.forEach(a => { html += `<th class="text-center">${a.hostname}</th>`; });
          html += `</tr></thead><tbody>`;
          Object.entries(data.different).forEach(([pkg, diffs]) => {
            html += `<tr><td><strong>${pkg}</strong></td>`;
            data.assets.forEach(asset => {
              const diff = diffs.find(d => d.machine_id === asset.machine_id);
              if (diff) {
                html += `<td class="text-center"><code>${diff.version}</code></td>`;
              } else {
                html += `<td class="text-center text-muted">â€”</td>`;
              }
            });
            html += '</tr>';
          });
          html += '</tbody></table></div></div>';
        }

        // Unique Packages
        if (data.only_in && Object.keys(data.only_in).length > 0) {
          html += `
                    <div class="card mb-3">
                        <div class="card-header bg-info-lt">
                            <h3 class="card-title text-info">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon me-2"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M12 12m-9 0a9 9 0 1 0 18 0a9 9 0 1 0 -18 0" /><path d="M12 8l0 4" /><path d="M12 16l.01 0" /></svg>
                                Unique Packages
                            </h3>
                        </div>
                        <div class="card-body">
                            <div class="row">`;
          Object.entries(data.only_in).forEach(([machineId, pkgs]) => {
            const asset = data.assets.find(a => a.machine_id === machineId);
            if (pkgs && pkgs.length > 0) {
              html += `
                            <div class="col-md-6 mb-3">
                                <div class="card">
                                    <div class="card-header py-2">
                                        <h3 class="card-title mb-0">${asset ? asset.hostname : machineId}</h3>
                                        <span class="badge bg-primary text-white ms-auto">${pkgs.length}</span>
                                    </div>
                                    <div class="card-body py-2" style="max-height: 200px; overflow-y: auto;">
                                        <div class="d-flex flex-wrap gap-1">
                                            ${pkgs.map(p => `<code class="small">${p}</code>`).join('')}
                                        </div>
                                    </div>
                                </div>
                            </div>`;
            }
          });
          html += '</div></div></div>';
        }

        // Common packages (collapsible since it's usually long)
        if (data.common && data.common.length > 0) {
          html += `
                    <div class="card mb-3">
                        <div class="card-header bg-success-lt" style="cursor: pointer;" onclick="document.getElementById('common-pkgs').classList.toggle('d-none')">
                            <h3 class="card-title text-success">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon me-2"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M5 12l5 5l10 -10" /></svg>
                                Common Packages (${data.common.length})
                            </h3>
                            <div class="card-actions">
                                <span class="text-muted small">Click to expand/collapse</span>
                            </div>
                        </div>
                        <div class="card-body d-none" id="common-pkgs" style="max-height: 300px; overflow-y: auto;">
                            <div class="row row-cols-2 row-cols-md-4 row-cols-lg-6 g-2">
                                ${data.common.map(p => `<div class="col"><code class="d-block text-truncate small" title="${p}">${p}</code></div>`).join('')}
                            </div>
                        </div>
                    </div>`;
        }

        if (!html) {
          html = '<div class="empty"><p class="empty-title">No comparison data available</p></div>';
        }

        resultsBody.innerHTML = html;
      })
      .catch(error => {
        resultsBody.innerHTML = `<div class="alert alert-danger">Error: ${error.message}</div>`;
      });
  }
</script>
{{ template "footer.html" . }}
