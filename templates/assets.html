{{ template "header.html" . }}
<div class="bg-txlog-indigo -mt-4 pt-4 pb-6 mb-6 print:hidden">
  <div class="max-w-7xl mx-auto px-6">
    <h2 class="font-display font-bold text-2xl text-white">{{ .title }}</h2>
  </div>
</div>

<div class="max-w-7xl mx-auto px-6 pb-8">
  <div class="bg-white rounded-3xl shadow-soft">
    <div
      class="border-b border-txlog-lavender px-6 py-4 flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
      <h3 class="font-display font-semibold text-lg">
        {{ if .search }}
        Assets
        {{ if eq .restart "true" }}that need to be restarted{{ end }}
        {{ if and (eq .restart "true") (eq .inactive "true") }} and{{ end }}
        {{ if eq .inactive "true" }} without data in the last 15 days{{ end }}
        containing <kbd class="bg-txlog-indigo/5 text-txlog-indigo text-xs font-mono px-2 py-1 rounded-md">{{ .search
          }}</kbd>
        {{ else }}
        Registered assets
        {{ if eq .restart "true" }}that need to be restarted{{ end }}
        {{ if and (eq .restart "true") (eq .inactive "true") }} and{{ end }}
        {{ if eq .inactive "true" }} without data in the last 15 days{{ end }}
        {{ end }}
      </h3>
      <div class="flex items-center gap-2">
        <input type="text" autocomplete="off" aria-label="Search assets" placeholder="Search by hostname or id"
          value="{{ .search }}" id="search" name="search" onkeydown="handleSearch(event)"
          class="border-2 border-txlog-lavender bg-white/50 px-3 py-2 rounded-xl outline-none focus:border-txlog-sky focus:ring-4 focus:ring-txlog-sky/20 transition-all placeholder:text-txlog-indigo/30 text-txlog-indigo text-sm font-medium w-48 sm:w-64">
        <div class="relative group">
          <label class="cursor-pointer flex items-center justify-center w-9 h-9 rounded-xl border-2 transition-all"
            id="restart-label">
            <input type="checkbox" id="restart" name="restart" value="true" class="sr-only peer" {{ if eq
              .restart "true" }} checked{{ end }}>
            <i data-lucide="refresh-cw-off" class="w-4 h-4 text-txlog-indigo/50 peer-checked:text-txlog-golden"></i>
          </label>
          <div
            class="absolute bottom-full left-1/2 -translate-x-1/2 mb-2 hidden group-hover:block bg-txlog-indigo text-white text-xs px-2 py-1 rounded-lg whitespace-nowrap z-10">
            Show only assets that need to be restarted</div>
        </div>
        <div class="relative group">
          <label class="cursor-pointer flex items-center justify-center w-9 h-9 rounded-xl border-2 transition-all"
            id="inactive-label">
            <input type="checkbox" id="inactive" name="inactive" value="true" class="sr-only peer" {{ if eq
              .inactive "true" }} checked{{ end }}>
            <i data-lucide="power" class="w-4 h-4 text-txlog-indigo/50 peer-checked:text-txlog-coral"></i>
          </label>
          <div
            class="absolute bottom-full left-1/2 -translate-x-1/2 mb-2 hidden group-hover:block bg-txlog-indigo text-white text-xs px-2 py-1 rounded-lg whitespace-nowrap z-10">
            Show only inactive assets (15+ days)</div>
        </div>
        <button onclick="search()"
          class="bg-txlog-sky text-white p-2 rounded-xl hover:-translate-y-0.5 hover:shadow-lg hover:shadow-txlog-sky/30 transition-all"
          aria-label="Search">
          <i data-lucide="search" class="w-4 h-4"></i>
        </button>
      </div>
    </div>

    {{ if eq (len .assets) 0 }}
    <div class="py-16 text-center">
      <i data-lucide="frown" class="w-12 h-12 text-txlog-indigo/20 mx-auto mb-4"></i>
      <p class="font-display font-semibold text-lg mb-2">No assets found{{ if .search }} containing <kbd
          class="bg-txlog-indigo/5 text-xs font-mono px-2 py-1 rounded-md">{{ .search }}</kbd>{{ end }}</p>
      <p class="text-sm text-txlog-indigo/50">Start by running <a href="https://txlog.rda.run/docs/agent"
          target="_blank" class="text-txlog-sky hover:underline">Txlog Agent</a> in one of your servers.</p>
    </div>
    {{ else }}
    <div class="overflow-x-auto">
      <table class="w-full text-sm">
        <thead>
          <tr class="border-b border-txlog-lavender/50 text-left">
            <th class="px-6 py-3 font-semibold text-txlog-indigo/70 text-xs uppercase tracking-wider">
              Hostname <i data-lucide="chevron-up" class="w-3 h-3 inline-block"></i>
            </th>
            <th class="px-6 py-3 font-semibold text-txlog-indigo/70 text-xs uppercase tracking-wider">Last Seen</th>
            <th class="px-6 py-3 w-1">&nbsp;</th>
          </tr>
        </thead>
        <tbody class="divide-y divide-txlog-lavender/30">
          {{ with .assets }}
          {{ range . }}
          <tr class="hover:bg-txlog-lavender/10 transition-colors">
            <td class="px-6 py-3">
              <div class="flex items-center gap-3">
                <span class="w-8 h-8 rounded-lg bg-txlog-lavender flex-shrink-0 relative">
                  <img src="/images/{{ brand .OS }}" class="w-full h-full object-cover rounded-lg" alt="">
                  {{ if derefBool .NeedsRestarting }}
                  <span class="absolute -top-0.5 -right-0.5 w-2.5 h-2.5 bg-txlog-golden rounded-full animate-pulse"
                    title="Asset must be restarted"></span>
                  {{ end }}
                </span>
                <div>
                  <div class="font-medium">{{ .Hostname }}</div>
                  <div class="text-txlog-indigo/50 text-xs">{{ .MachineID }}</div>
                </div>
              </div>
            </td>
            <td class="px-6 py-3">
              <div class="flex items-center gap-2">
                <span class="{{ timeStatusClass .ExecutedAt }}"></span>
                <span class="text-txlog-indigo/60">{{ formatDateTime .ExecutedAt }}</span>
              </div>
            </td>
            <td class="px-6 py-3">
              <a class="text-txlog-sky text-sm font-medium px-3 py-1 rounded-lg border border-txlog-sky/20 hover:bg-txlog-sky/10 transition-colors" href="/assets/{{ .MachineID }}">Details</a>
            </td>
          </tr>
          {{ end }}
          {{ end }}
        </tbody>
      </table>
    </div>

    <div class="border-t border-txlog-lavender/50 px-6 py-4 flex items-center justify-between">
      <p class="text-sm text-txlog-indigo/50">Showing <span>{{ add $.offset 1 }}</span> to <span>{{ min (add $.offset
          $.limit) $.totalRecords }}</span> of <span>{{ .totalRecords }}</span> entries</p>
      <div class="flex items-center gap-1">
        <a class="px-3 py-1.5 rounded-lg text-sm font-medium {{ if eq $.page 1 }}text-txlog-indigo/30 pointer-events-none{{ else }}text-txlog-indigo hover:bg-txlog-lavender/30{{ end }} transition-colors"
          href="?page={{ .page | add -1 }}">
          <i data-lucide="chevron-left" class="w-4 h-4 inline-block"></i> prev
        </a>
        {{ range $i := iterate 1 .totalPages }}
        <a class="px-3 py-1.5 rounded-lg text-sm font-medium {{ if eq $.page $i }}bg-txlog-sky text-white{{ else }}text-txlog-indigo hover:bg-txlog-lavender/30{{ end }} transition-colors"
          href="?page={{ $i }}">{{ $i }}</a>
        {{ end }}
        <a class="px-3 py-1.5 rounded-lg text-sm font-medium {{ if eq $.page $.totalPages }}text-txlog-indigo/30 pointer-events-none{{ else }}text-txlog-indigo hover:bg-txlog-lavender/30{{ end }} transition-colors"
          href="?page={{ .page | add 1 }}">
          next <i data-lucide="chevron-right" class="w-4 h-4 inline-block"></i>
        </a>
      </div>
    </div>
    {{ end }}
  </div>
</div>

<div id="modal-success" class="fixed inset-0 z-50 hidden items-center justify-center bg-black/50"
  onclick="if(event.target===this)closeModal('modal-success')">
  <div data-modal-panel
    class="bg-white rounded-3xl shadow-soft max-w-sm w-full mx-4 transform transition-all scale-95 opacity-0">
    <div class="h-1 bg-txlog-leaf rounded-t-3xl"></div>
    <div class="p-6 text-center">
      <i data-lucide="check-circle" class="w-12 h-12 text-txlog-leaf mx-auto mb-3"></i>
      <h3 class="font-display font-semibold text-lg mb-2">Asset deleted successfully</h3>
      <p class="text-sm text-txlog-indigo/60">All data for asset <code id="deleted-asset-id"
          class="bg-txlog-indigo/5 text-xs font-mono px-2 py-1 rounded-md"></code> has been permanently removed.</p>
    </div>
    <div class="border-t border-txlog-lavender px-6 py-4">
      <button onclick="closeModal('modal-success')"
        class="w-full bg-txlog-leaf text-white font-medium py-2.5 rounded-xl hover:-translate-y-0.5 hover:shadow-lg hover:shadow-txlog-leaf/30 transition-all">Close</button>
    </div>
  </div>
</div>

<script>
  function search() {
    var searchValue = document.getElementById('search').value;
    var restartValue = document.getElementById('restart').checked;
    var inactiveValue = document.getElementById('inactive').checked;
    var url = new URL(window.location.href);
    url.searchParams.set('search', searchValue);
    url.searchParams.set('restart', restartValue);
    url.searchParams.set('inactive', inactiveValue);
    window.location.href = url.toString();
  }
  function handleSearch(event) {
    if (event.key === 'Enter') search();
  }
  document.addEventListener('DOMContentLoaded', function () {
    var deletedAssetId = sessionStorage.getItem('assetDeleted');
    if (deletedAssetId) {
      sessionStorage.removeItem('assetDeleted');
      document.getElementById('deleted-asset-id').textContent = deletedAssetId;
      openModal('modal-success');
    }
  });
</script>

{{ template "footer.html" . }}
