{{ template "header.html" . }}
<div class="bg-txlog-indigo -mt-4 pt-4 pb-6 mb-6 print:hidden">
  <div class="max-w-7xl mx-auto px-6">
    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
      <div>
        <p class="text-white/60 text-sm mb-1">Asset Details</p>
        <h2 class="font-display font-bold text-2xl text-white">{{ .hostname }}</h2>
      </div>
      <div class="flex items-center gap-3">
        <a href="/analytics/compare?preselect={{ .machine_id }}"
          class="inline-flex items-center gap-2 border-2 border-white/30 text-white text-sm font-medium px-4 py-2 rounded-xl hover:bg-white/10 transition-all">
          <i data-lucide="columns-2" class="w-4 h-4"></i> Compare with...
        </a>
        {{ if .needs_restarting }}
        <div
          class="bg-txlog-golden/20 border border-txlog-golden/40 text-white px-4 py-2 rounded-xl flex items-center gap-2 text-sm">
          <i data-lucide="triangle-alert" class="w-4 h-4 text-txlog-golden"></i>
          Asset must be restarted
          <a href="#" onclick="openModal('modal-reason')" class="underline text-txlog-golden ml-1">Why?</a>
        </div>
        {{ end }}
      </div>
    </div>
  </div>
</div>

<div class="max-w-7xl mx-auto px-6 pb-8 space-y-6">
  <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
    <div class="bg-white rounded-2xl shadow-soft p-5 flex items-center gap-4">
      <span class="w-10 h-10 bg-txlog-sky/10 rounded-xl flex items-center justify-center flex-shrink-0">
        <i data-lucide="id-card" class="w-5 h-5 text-txlog-sky"></i>
      </span>
      <div class="min-w-0">
        <div class="font-medium truncate">{{ .machine_id }}</div>
        <div class="text-xs text-txlog-indigo/50">Asset ID</div>
      </div>
    </div>
    <div class="bg-white rounded-2xl shadow-soft p-5 flex items-center gap-4">
      <span class="w-10 h-10 rounded-xl overflow-hidden bg-txlog-lavender flex-shrink-0">
        <img src="/images/{{ with index .executions 0 }}{{ brand .OS }}{{ end }}" class="w-full h-full object-cover"
          alt="">
      </span>
      <div>
        <div class="font-medium">{{ with index .executions 0 }}{{ .OS }}{{ end }}</div>
        <div class="text-xs text-txlog-indigo/50">OS version</div>
      </div>
    </div>
    <div class="bg-white rounded-2xl shadow-soft p-5 flex items-center gap-4">
      <span class="w-10 h-10 bg-txlog-leaf/10 rounded-xl flex items-center justify-center flex-shrink-0">
        <i data-lucide="git-merge" class="w-5 h-5 text-txlog-leaf"></i>
      </span>
      <div>
        <div class="font-medium">{{ with index .executions 0 }}{{ .AgentVersion }}{{ end }}</div>
        <div class="text-xs text-txlog-indigo/50">Agent version</div>
      </div>
    </div>
  </div>

  <div class="bg-white rounded-3xl shadow-soft overflow-hidden">
    <div class="border-b border-txlog-lavender px-6 py-4">
      <h3 class="font-display font-semibold text-lg">Transactions</h3>
    </div>
    {{ if eq (len .transactions) 0 }}
    <div class="py-12 text-center">
      <i data-lucide="frown" class="w-12 h-12 text-txlog-indigo/20 mx-auto mb-4"></i>
      <p class="font-semibold mb-1">No transactions found for this asset</p>
      <p class="text-sm text-txlog-indigo/50">Start by running <a href="https://txlog.rda.run/docs/agent"
          target="_blank" class="text-txlog-sky hover:underline">Txlog Agent</a> in one of your servers.</p>
    </div>
    {{ else }}
    <div class="overflow-x-auto">
      <table class="w-full text-sm">
        <thead>
          <tr class="border-b border-txlog-lavender/50 text-left">
            <th class="px-6 py-3 font-semibold text-txlog-indigo/70 text-xs uppercase tracking-wider">ID <i
                data-lucide="chevron-up" class="w-3 h-3 inline-block"></i></th>
            <th class="px-6 py-3 font-semibold text-txlog-indigo/70 text-xs uppercase tracking-wider">Execution Time
            </th>
            <th class="px-6 py-3 font-semibold text-txlog-indigo/70 text-xs uppercase tracking-wider">User</th>
            <th class="px-6 py-3 font-semibold text-txlog-indigo/70 text-xs uppercase tracking-wider">Actions</th>
            <th class="px-6 py-3 font-semibold text-txlog-indigo/70 text-xs uppercase tracking-wider">Packages Altered
            </th>
            <th class="px-6 py-3 font-semibold text-txlog-indigo/70 text-xs uppercase tracking-wider">Command</th>
            <th class="px-6 py-3 w-1">&nbsp;</th>
          </tr>
        </thead>
        <tbody class="divide-y divide-txlog-lavender/30">
          {{ with .transactions }}
          {{ range . }}
          <tr class="hover:bg-txlog-lavender/10 transition-colors">
            <td class="px-6 py-3">
              <div class="relative group inline-block">
                <kbd class="bg-txlog-indigo/5 text-txlog-indigo text-xs font-mono px-2 py-1 rounded-md">{{
                  .TransactionID }}</kbd>
                <div
                  class="absolute bottom-full left-1/2 -translate-x-1/2 mb-2 hidden group-hover:block bg-txlog-indigo text-white text-xs px-2 py-1 rounded-lg whitespace-nowrap z-10">
                  {{ .Actions }}</div>
              </div>
            </td>
            <td class="px-6 py-3">{{ formatDateTime .BeginTime }}</td>
            <td class="px-6 py-3">{{ dnfUser .User }}</td>
            <td class="px-6 py-3">
              <div class="flex items-center gap-1">
                <span class="w-6 h-6 rounded-md flex items-center justify-center text-xs {{ if hasAction .Actions "Install" }}bg-txlog-leaf text-white{{ else }}bg-txlog-indigo/5 text-txlog-indigo/30{{ end }}" title="Install"><i data-lucide="plus" class="w-3 h-3"></i></span>
                <span class="w-6 h-6 rounded-md flex items-center justify-center text-xs {{ if hasAction .Actions "Upgrade" }}bg-txlog-leaf text-white{{ else }}bg-txlog-indigo/5 text-txlog-indigo/30{{ end }}" title="Upgrade"><i data-lucide="arrow-up" class="w-3 h-3"></i></span>
                <span class="w-6 h-6 rounded-md flex items-center justify-center text-xs {{ if hasAction .Actions "Reinstall" }}bg-txlog-golden text-white{{ else }}bg-txlog-indigo/5 text-txlog-indigo/30{{ end }}" title="Reinstall"><i data-lucide="refresh-cw" class="w-3 h-3"></i></span>
                <span class="w-6 h-6 rounded-md flex items-center justify-center text-xs {{ if hasAction .Actions "Downgrade" }}bg-txlog-coral text-white{{ else }}bg-txlog-indigo/5 text-txlog-indigo/30{{ end }}" title="Downgrade"><i data-lucide="arrow-down" class="w-3 h-3"></i></span>
                <span class="w-6 h-6 rounded-md flex items-center justify-center text-xs {{ if hasAction .Actions "Removed" }}bg-txlog-coral text-white{{ else }}bg-txlog-indigo/5 text-txlog-indigo/30{{ end }}" title="Removed"><i data-lucide="minus" class="w-3 h-3"></i></span>
                <span class="w-6 h-6 rounded-md flex items-center justify-center text-xs {{ if hasAction .Actions "Obsolete" }}bg-purple-500 text-white{{ else }}bg-txlog-indigo/5 text-txlog-indigo/30{{ end }}" title="Obsolete"><i data-lucide="circle-check" class="w-3 h-3"></i></span>
                <span class="w-6 h-6 rounded-md flex items-center justify-center text-xs {{ if hasAction .Actions "Reason Change" }}bg-purple-500 text-white{{ else }}bg-txlog-indigo/5 text-txlog-indigo/30{{ end }}" title="Reason Change"><i data-lucide="replace" class="w-3 h-3"></i></span>
              </div>
            </td>
            <td class="px-6 py-3">{{ .Altered }}</td>
            {{ if .CommandLine }}
            <td class="px-6 py-3 max-w-[300px] truncate" title="{{ .CommandLine }}">{{ .CommandLine }}</td>
            {{ else }}
            <td class="px-6 py-3 text-txlog-indigo/40 max-w-[300px]">No command recorded</td>
            {{ end }}
            <td class="px-6 py-3">
              <a class="text-txlog-sky hover:underline text-sm font-medium" href="#"
                onclick="showModal('{{ .TransactionID }}')">Details</a>
            </td>
          </tr>
          {{ end }}
          {{ end }}
        </tbody>
      </table>
    </div>
    {{ end }}
  </div>

  <div class="bg-white rounded-3xl shadow-soft overflow-hidden">
    <div class="border-b border-txlog-lavender px-6 py-4">
      <h3 class="font-display font-semibold text-lg">Last 100 executions <span
          class="text-sm text-txlog-indigo/50 font-normal ml-1">with transactions</span></h3>
    </div>
    {{ if eq (len .executions) 0 }}
    <div class="py-12 text-center">
      <i data-lucide="frown" class="w-12 h-12 text-txlog-indigo/20 mx-auto mb-4"></i>
      <p class="font-semibold mb-1">No executions found for this asset</p>
      <p class="text-sm text-txlog-indigo/50">Start by running <a href="https://txlog.rda.run/docs/agent"
          target="_blank" class="text-txlog-sky hover:underline">Txlog Agent</a> in one of your servers.</p>
    </div>
    {{ else }}
    <div class="overflow-x-auto">
      <table class="w-full text-sm">
        <thead>
          <tr class="border-b border-txlog-lavender/50 text-left">
            <th class="px-6 py-3 font-semibold text-txlog-indigo/70 text-xs uppercase tracking-wider">Execution ID <i
                data-lucide="chevron-up" class="w-3 h-3 inline-block"></i></th>
            <th class="px-6 py-3 font-semibold text-txlog-indigo/70 text-xs uppercase tracking-wider">Hostname</th>
            <th class="px-6 py-3 font-semibold text-txlog-indigo/70 text-xs uppercase tracking-wider">Execution Time
            </th>
            <th class="px-6 py-3 font-semibold text-txlog-indigo/70 text-xs uppercase tracking-wider">Transactions
              Processed</th>
            <th class="px-6 py-3 font-semibold text-txlog-indigo/70 text-xs uppercase tracking-wider">Transactions Sent
            </th>
            <th class="px-6 py-3 w-1">&nbsp;</th>
          </tr>
        </thead>
        <tbody class="divide-y divide-txlog-lavender/30">
          {{ with .executions }}
          {{ range . }}
          <tr class="hover:bg-txlog-lavender/10 transition-colors">
            <td class="px-6 py-3">
              <span
                class="inline-flex items-center gap-1.5 bg-txlog-indigo/5 text-txlog-indigo text-xs font-mono px-2 py-1 rounded-md">
                <span
                  class="w-2 h-2 rounded-full {{ if eq .Success true }}bg-txlog-leaf{{ else }}bg-txlog-coral{{ end }}"></span>
                {{ .ExecutionID }}
              </span>
            </td>
            <td class="px-6 py-3"><kbd
                class="bg-txlog-indigo/5 text-txlog-indigo text-xs font-mono px-2 py-1 rounded-md">{{ .Hostname }}</kbd>
            </td>
            <td class="px-6 py-3">{{ formatDateTime .ExecutedAt }}</td>
            <td class="px-6 py-3">{{ .TransactionsProcessed }}</td>
            <td class="px-6 py-3">{{ .TransactionsSent }}</td>
            <td class="px-6 py-3">
              <a class="text-txlog-sky hover:underline text-sm font-medium"
                href="/executions/{{ .ExecutionID }}">Details</a>
            </td>
          </tr>
          {{ end }}
          {{ end }}
        </tbody>
      </table>
    </div>
    {{ end }}
  </div>

  <div class="bg-white rounded-3xl shadow-soft overflow-hidden">
    <div class="border-b border-txlog-lavender px-6 py-4">
      <h3 class="font-display font-semibold text-lg">Other assets <span
          class="text-sm text-txlog-indigo/50 font-normal ml-1">sharing the same hostname</span></h3>
    </div>
    {{ if eq (len .other_assets) 0 }}
    <div class="py-12 text-center">
      <i data-lucide="smile" class="w-12 h-12 text-txlog-leaf/40 mx-auto mb-4"></i>
      <p class="font-semibold">Great! No other assets are sharing this hostname.</p>
    </div>
    {{ else }}
    <div class="overflow-x-auto">
      <table class="w-full text-sm">
        <thead>
          <tr class="border-b border-txlog-lavender/50 text-left">
            <th class="px-6 py-3 font-semibold text-txlog-indigo/70 text-xs uppercase tracking-wider">Asset ID</th>
            <th class="px-6 py-3 font-semibold text-txlog-indigo/70 text-xs uppercase tracking-wider">Hostname</th>
            <th class="px-6 py-3 font-semibold text-txlog-indigo/70 text-xs uppercase tracking-wider">Last seen <i
                data-lucide="chevron-up" class="w-3 h-3 inline-block"></i></th>
            <th class="px-6 py-3 font-semibold text-txlog-indigo/70 text-xs uppercase tracking-wider">Agent version</th>
            <th class="px-6 py-3 font-semibold text-txlog-indigo/70 text-xs uppercase tracking-wider">OS version</th>
          </tr>
        </thead>
        <tbody class="divide-y divide-txlog-lavender/30">
          {{ with .other_assets }}
          {{ range . }}
          <tr class="hover:bg-txlog-lavender/10 transition-colors">
            <td class="px-6 py-3"><a href="/assets/{{ .MachineID }}" class="text-txlog-sky hover:underline"><kbd
                  class="bg-txlog-indigo/5 text-txlog-indigo text-xs font-mono px-2 py-1 rounded-md">{{ .MachineID
                  }}</kbd></a></td>
            <td class="px-6 py-3"><kbd
                class="bg-txlog-indigo/5 text-txlog-indigo text-xs font-mono px-2 py-1 rounded-md">{{ .Hostname }}</kbd>
            </td>
            <td class="px-6 py-3">{{ formatDateTime .ExecutedAt }}</td>
            <td class="px-6 py-3">{{ .AgentVersion }}</td>
            <td class="px-6 py-3">{{ .OS }}</td>
          </tr>
          {{ end }}
          {{ end }}
        </tbody>
      </table>
    </div>
    {{ end }}
    <div class="border-t border-txlog-lavender px-6 py-3 text-sm text-txlog-indigo/50">
      These assets may belong to previous versions of this hostname, which is common in cases where the VM is replaced
      by a new one.
    </div>
  </div>

  <div class="bg-txlog-coral/5 border border-txlog-coral/20 rounded-3xl overflow-hidden">
    <div class="border-b border-txlog-coral/20 px-6 py-4">
      <h3 class="font-display font-semibold text-lg text-txlog-coral">Danger Zone</h3>
    </div>
    <div class="p-6">
      <button type="button" onclick="openModal('modal-delete')"
        class="w-full border-2 border-txlog-coral text-txlog-coral font-medium py-3 rounded-xl hover:bg-txlog-coral hover:text-white transition-all">
        Delete all asset data...
      </button>
    </div>
  </div>
</div>

<div id="modal-scrollable" class="fixed inset-0 z-50 hidden items-center justify-center bg-black/50"
  onclick="if(event.target===this)closeModal('modal-scrollable')">
  <div data-modal-panel
    class="bg-white rounded-3xl shadow-soft max-w-2xl w-full mx-4 max-h-[80vh] flex flex-col transform transition-all scale-95 opacity-0">
    <div class="border-b border-txlog-lavender px-6 py-4 flex items-center justify-between flex-shrink-0">
      <h5 class="font-display font-semibold text-lg" id="modal-title">Loading...</h5>
      <button onclick="closeModal('modal-scrollable')"
        class="text-txlog-indigo/40 hover:text-txlog-indigo transition-colors"><i data-lucide="x"
          class="w-5 h-5"></i></button>
    </div>
    <div class="overflow-y-auto flex-1 p-6">
      <div class="grid grid-cols-2 gap-x-6 gap-y-2 text-sm mb-6">
        <p><strong>Begin Time:</strong> <span id="modal-begin-time">...</span></p>
        <p><strong>End Time:</strong> <span id="modal-end-time">...</span></p>
        <p><strong>User:</strong> <span id="modal-user">...</span></p>
        <p><strong>Return Code:</strong> <span id="modal-return-code">...</span></p>
        <p><strong>Release Version:</strong> <span id="modal-release-version">...</span></p>
        <p><strong>Command Line:</strong> <code id="modal-command"
            class="bg-txlog-indigo/5 text-xs font-mono px-2 py-1 rounded-md">...</code></p>
        <p><strong>Actions:</strong> <span id="modal-actions">...</span></p>
        <p><strong>Packages altered:</strong> <span id="modal-altered">...</span></p>
      </div>
      <table class="w-full text-sm">
        <thead>
          <tr class="border-b border-txlog-lavender/50 text-left">
            <th class="pb-3 font-semibold text-txlog-indigo/70 text-xs uppercase tracking-wider">Action</th>
            <th class="pb-3 font-semibold text-txlog-indigo/70 text-xs uppercase tracking-wider">Name</th>
            <th class="pb-3 font-semibold text-txlog-indigo/70 text-xs uppercase tracking-wider">Version</th>
            <th class="pb-3 font-semibold text-txlog-indigo/70 text-xs uppercase tracking-wider">Release</th>
            <th class="pb-3 font-semibold text-txlog-indigo/70 text-xs uppercase tracking-wider">Repo</th>
          </tr>
        </thead>
        <tbody id="modal-table-body" class="divide-y divide-txlog-lavender/30">
          <tr>
            <td colspan="5" class="py-4">
              <div class="h-2 bg-txlog-lavender rounded-full overflow-hidden">
                <div class="h-full bg-txlog-sky rounded-full animate-pulse w-2/3"></div>
              </div>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
    <div class="border-t border-txlog-lavender px-6 py-4 flex-shrink-0">
      <button onclick="closeModal('modal-scrollable')"
        class="w-full bg-txlog-sky text-white font-medium py-2.5 rounded-xl hover:-translate-y-0.5 hover:shadow-lg hover:shadow-txlog-sky/30 transition-all">Close</button>
    </div>
  </div>
</div>

<div id="modal-reason" class="fixed inset-0 z-50 hidden items-center justify-center bg-black/50"
  onclick="if(event.target===this)closeModal('modal-reason')">
  <div data-modal-panel
    class="bg-white rounded-3xl shadow-soft max-w-2xl w-full mx-4 max-h-[80vh] flex flex-col transform transition-all scale-95 opacity-0">
    <div class="border-b border-txlog-lavender px-6 py-4 flex items-center justify-between flex-shrink-0">
      <h5 class="font-display font-semibold text-lg">Reason to restart the asset</h5>
      <button onclick="closeModal('modal-reason')"
        class="text-txlog-indigo/40 hover:text-txlog-indigo transition-colors"><i data-lucide="x"
          class="w-5 h-5"></i></button>
    </div>
    <div class="overflow-y-auto flex-1 p-6 text-sm leading-relaxed">
      {{ .restarting_reason | text2html }}
    </div>
    <div class="border-t border-txlog-lavender px-6 py-4 flex-shrink-0">
      <button onclick="closeModal('modal-reason')"
        class="w-full bg-txlog-sky text-white font-medium py-2.5 rounded-xl hover:-translate-y-0.5 hover:shadow-lg hover:shadow-txlog-sky/30 transition-all">Close</button>
    </div>
  </div>
</div>

<div id="modal-delete" class="fixed inset-0 z-50 hidden items-center justify-center bg-black/50"
  onclick="if(event.target===this)closeModal('modal-delete')">
  <div data-modal-panel
    class="bg-white rounded-3xl shadow-soft max-w-sm w-full mx-4 transform transition-all scale-95 opacity-0 overflow-hidden">
    <div class="h-1 bg-txlog-coral rounded-t-3xl"></div>
    <div class="p-6 text-center">
      <i data-lucide="triangle-alert" class="w-12 h-12 text-txlog-coral mx-auto mb-3"></i>
      <h3 class="font-display font-semibold text-lg mb-2">Are you sure?</h3>
      <p class="text-sm text-txlog-indigo/60 mb-2">Do you really want to remove all data for this asset ID? <strong>What
          you do cannot be undone.</strong></p>
      <code class="bg-txlog-indigo/5 text-xs font-mono px-2 py-1 rounded-md">{{ .machine_id }}</code>
    </div>
    <div class="border-t border-txlog-lavender px-6 py-4 grid grid-cols-2 gap-3">
      <button onclick="closeModal('modal-delete')"
        class="border-2 border-txlog-lavender text-txlog-indigo font-medium py-2.5 rounded-xl hover:bg-txlog-lavender/20 transition-all">Cancel</button>
      <button id="delete-asset-btn" onclick="deleteAsset('{{ .machine_id }}')"
        class="bg-txlog-coral text-white font-medium py-2.5 rounded-xl hover:-translate-y-0.5 hover:shadow-lg hover:shadow-txlog-coral/30 transition-all flex items-center justify-center gap-2">
        <span id="delete-btn-text">Delete all asset data</span>
        <svg id="delete-btn-spinner" class="animate-spin w-4 h-4 hidden" xmlns="http://www.w3.org/2000/svg" fill="none"
          viewBox="0 0 24 24">
          <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
          <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path>
        </svg>
      </button>
    </div>
  </div>
</div>

<script>
  function showReason() {
    openModal('modal-reason');
  }

  function showModal(transactionId) {
    fetch('/v1/items?machine_id={{ .machine_id }}&transaction_id=' + transactionId)
      .then(function (response) { return response.json(); })
      .then(function (result) {
        document.getElementById('modal-begin-time').textContent = result.begin_time;
        document.getElementById('modal-end-time').textContent = result.end_time;
        document.getElementById('modal-user').textContent = result.user;
        document.getElementById('modal-return-code').textContent = result.return_code;
        document.getElementById('modal-release-version').textContent = result.release_version;
        document.getElementById('modal-command').textContent = result.command_line || "No command recorded";
        document.getElementById('modal-actions').textContent = result.actions;
        document.getElementById('modal-altered').textContent = result.altered;
        if (result.items && result.items.length != 0) {
          var tableBody = document.getElementById('modal-table-body');
          tableBody.innerHTML = '';
          result.items.forEach(function (item) {
            var row = document.createElement('tr');
            row.className = 'hover:bg-txlog-lavender/10 transition-colors';
            row.innerHTML = '<td class="py-2">' + item.action + '</td><td class="py-2">' + item.name + '</td><td class="py-2">' + item.version + '</td><td class="py-2">' + item.release + '</td><td class="py-2">' + item.repo + '</td>';
            tableBody.appendChild(row);
          });
        } else {
          document.getElementById('modal-table-body').innerHTML = '<tr><td colspan="5" class="py-4 text-txlog-indigo/50">No items recorded.</td></tr>';
        }
      })
      .catch(function (error) { console.error('Error:', error); });
    document.getElementById('modal-title').textContent = "Details of transaction #" + transactionId;
    openModal('modal-scrollable');
  }

  function deleteAsset(assetId) {
    var btn = document.getElementById('delete-asset-btn');
    var btnSpinner = document.getElementById('delete-btn-spinner');
    btn.disabled = true;
    btnSpinner.classList.remove('hidden');
    fetch('/assets/' + assetId, { method: 'DELETE' })
      .then(function (response) {
        if (response.ok || response.redirected) {
          sessionStorage.setItem('assetDeleted', assetId);
          window.location.href = "/assets";
        } else {
          btn.disabled = false;
          btnSpinner.classList.add('hidden');
          alert('Failed to delete asset.');
        }
      })
      .catch(function () {
        btn.disabled = false;
        btnSpinner.classList.add('hidden');
        alert('Failed to delete asset.');
      });
  }
</script>
{{ template "footer.html" . }}
