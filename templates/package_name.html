{{ template "header.html" . }}
<!-- Page header -->
<div class="page-header d-print-none text-white">
  <div class="container-xl">
    <div class="row g-2 align-items-center">
      <div class="col">
        <h2 class="page-title">
          Package details
        </h2>
      </div>
      <div class="col-auto ms-auto d-print-none">
        <div class="btn-list">
          <a class="btn btn-ghost btn-secondary" href="https://pkgs.org/search/?q={{ .name }}" target="_blank">Search for this package on pkgs.org&nbsp;
            <svg  xmlns="http://www.w3.org/2000/svg"  width="24"  height="24"  viewBox="0 0 24 24"  fill="none"  stroke="currentColor"  stroke-width="2"  stroke-linecap="round"  stroke-linejoin="round"  class="icon icon-tabler icons-tabler-outline icon-tabler-external-link"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M12 6h-6a2 2 0 0 0 -2 2v10a2 2 0 0 0 2 2h10a2 2 0 0 0 2 -2v-6" /><path d="M11 13l9 -9" /><path d="M15 4h5v5" /></svg>
          </a>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="page-body">
  <div class="container-xl">
    <div class="row row-deck row-cards">

      <div class="col-12">
        <div class="card">
          <div class="card-header">
            <h3 class="card-title">{{ .name }}</h3>
          </div>
          <div class="card-body">
            <div class="datagrid">
              <div class="datagrid-item">
                <div class="datagrid-title">Architecture</div>
                <div class="datagrid-content">
                  {{ range $index, $arch := .archList }}
                  {{- if $index }}, {{ end -}}{{ $arch }}
                  {{- end }}
                </div>
              </div>
              <div class="datagrid-item">
                <div class="datagrid-title">Repository</div>
                <div class="datagrid-content">
                  {{ range $index, $repo := .repoList }}
                  {{- if $index }}, {{ end -}}{{ $repo }}
                  {{- end }}
                </div>
              </div>
              <div class="datagrid-item">
                <div class="datagrid-title">Last seen</div>
                <div class="datagrid-content">
                  {{ if .packages }}{{ formatDateTime (index .packages 0).LastSeen }}{{ end }}
                </div>
              </div>

            </div>
          </div>
        </div>
      </div>

      <div class="col-6">
        <div class="card">
          <div class="card-header">
            <h3 class="card-title">Version timeline</h3>
          </div>
          <div class="card-body">
            <ul class="timeline">
            {{ range .packages }}
            <li class="timeline-event">
              <div class="timeline-event-icon">
                <svg  xmlns="http://www.w3.org/2000/svg"  width="24"  height="24"  viewBox="0 0 24 24"  fill="none"  stroke="currentColor"  stroke-width="2"  stroke-linecap="round"  stroke-linejoin="round"  class="icon icon-tabler icons-tabler-outline icon-tabler-package"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M12 3l8 4.5l0 9l-8 4.5l-8 -4.5l0 -9l8 -4.5" /><path d="M12 12l8 -4.5" /><path d="M12 12l0 9" /><path d="M12 12l-8 -4.5" /><path d="M16 5.25l-8 4.5" /></svg>
              </div>
              <div class="card timeline-event-card">
                <div class="card-body">
                  <div class="text-secondary float-end">
                    <a href="javascript:loadPackageAssets('{{ $.name }}', '{{ .Version }}', '{{ .Release }}')">List assets
                      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-end icon-2"><path d="M9 6l6 6l-6 6"></path></svg>
                    </a>
                  </div>
                  <h4>{{ .Version }}<span class="text-secondary">-{{ .Release }}-{{ .Arch }}</span></h4>
                  <p class="text-secondary">
                    <strong>Repo:</strong> {{ .Repo }}<br/>
                    <strong>Last seen:</strong> {{ formatDateTime .LastSeen }}
                  </p>
                </div>
              </div>
            </li>
            {{ end }}
            </ul>
          </div>
        </div>
      </div>

      <div class="col-6">
        <div id="table-placeholder" class="card" style="display: none;">
          <ul class="list-group list-group-flush placeholder-glow">
            <li class="list-group-item">
              <div class="row align-items-center">
                <div class="col-7">
                  <div class="placeholder placeholder-xs col-9"></div>
                </div>
                <div class="col-2 ms-auto text-end">
                  <div class="placeholder placeholder-xs col-8"></div>
                </div>
              </div>
            </li>
            <li class="list-group-item">
              <div class="row align-items-center">
                <div class="col-7">
                  <div class="placeholder placeholder-xs col-9"></div>
                </div>
                <div class="col-2 ms-auto text-end">
                  <div class="placeholder placeholder-xs col-8"></div>
                </div>
              </div>
            </li>
            <li class="list-group-item">
              <div class="row align-items-center">
                <div class="col-7">
                  <div class="placeholder placeholder-xs col-9"></div>
                </div>
                <div class="col-2 ms-auto text-end">
                  <div class="placeholder placeholder-xs col-8"></div>
                </div>
              </div>
            </li>
            <li class="list-group-item">
              <div class="row align-items-center">
                <div class="col-7">
                  <div class="placeholder placeholder-xs col-9"></div>
                </div>
                <div class="col-2 ms-auto text-end">
                  <div class="placeholder placeholder-xs col-8"></div>
                </div>
              </div>
            </li>
          </ul>
        </div>

        <div id="table-assets" class="card" style="display: none;">
          <div class="card-header">
            <h3 class="card-title">Assets running version <kbd id="version-display">loading...</kbd></h3>
          </div>

          <div id="assets-table-container">
            <div class="table-responsive">
              <table class="table table-selectable card-table table-vcenter text-nowrap datatable">
                <thead>
                  <tr>
                    <th class="w-1">Hostname</th>
                    <th></th>
                  </tr>
                </thead>
                <tbody id="assets-table-body">
                  <!-- Dynamic content will be loaded here -->
                </tbody>
              </table>
            </div>
            <div class="card-footer" id="table-footer" style="display: none;">
              <div class="row g-2 justify-content-center justify-content-sm-between">
                <div class="col-auto d-flex align-items-center">
                  <p class="m-0 text-secondary">Showing <strong id="entries-count">0</strong> entries</p>
                </div>
              </div>
            </div>
          </div>

          <div id="empty-state-container" style="display: none;">
            <div class="card-body">
              <div class="empty">
                <div class="empty-icon">
                  <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"></path><path d="M12 3l8 4.5l0 9l-8 4.5l-8 -4.5l0 -9l8 -4.5"></path><path d="M12 12l8 -4.5"></path><path d="M12 12l0 9"></path><path d="M12 12l-8 -4.5"></path><path d="M16 5.25l-8 4.5"></path></svg>
                </div>
                <p class="empty-title">No assets found</p>
                <p class="empty-subtitle text-muted" id="empty-state-subtitle"></p>
              </div>
            </div>
          </div>
        </div>

        <script>
        let isLoadingAssets = false;

        async function loadPackageAssets(packageName, version, release) {
          // Prevent multiple simultaneous calls
          if (isLoadingAssets) {
            return;
          }

          isLoadingAssets = true;

          const tableCard = document.getElementById('table-assets');
          const tableBody = document.getElementById('assets-table-body');
          const versionDisplay = document.getElementById('version-display');
          const entriesCount = document.getElementById('entries-count');
          const assetsTableContainer = document.getElementById('assets-table-container');
          const emptyStateContainer = document.getElementById('empty-state-container');
          const emptyStateSubtitle = document.getElementById('empty-state-subtitle');

          try {
            // Show loading state
            const displayVersion = version + '-' + release;
            versionDisplay.textContent = displayVersion;
            tableCard.style.display = 'block';
            assetsTableContainer.style.display = 'none';
            emptyStateContainer.style.display = 'none';
            document.getElementById('table-placeholder').style.display = 'block';

            // Fetch data from API
            const response = await fetch(`/v1/packages/${encodeURIComponent(packageName)}/${encodeURIComponent(version)}/${encodeURIComponent(release)}/assets`);

            if (!response.ok) {
              throw new Error(`HTTP error! status: ${response.status}`);
            }

            const assets = await response.json();

            // Clear table body
            tableBody.innerHTML = '';

            if (assets && assets.length > 0) {
              // Populate table with assets
              assets.forEach(asset => {
                const row = document.createElement('tr');
                row.innerHTML = `
                  <td>${asset.hostname || 'Unknown'}</td>
                  <td class="text-end">
                    <a class="btn align-text-top" href="/assets/${asset.machine_id}">Details</a>
                  </td>
                `;
                tableBody.appendChild(row);
              });

              // Update footer
              entriesCount.textContent = assets.length;
              assetsTableContainer.style.display = 'block';
              emptyStateContainer.style.display = 'none';
            } else {
              emptyStateSubtitle.textContent = `No assets are currently using version ${displayVersion}`;
              assetsTableContainer.style.display = 'none';
              emptyStateContainer.style.display = 'block';
            }

          } catch (error) {
            // Check if it's a 404 error (no assets found)
            if (error.message.includes('404')) {
              tableBody.innerHTML = '<tr><td colspan="2" class="text-center text-muted">No assets found for this version</td></tr>';
            } else {
              tableBody.innerHTML = '<tr><td colspan="2" class="text-center text-danger">Error loading assets data</td></tr>';
            }
            assetsTableContainer.style.display = 'block';
            emptyStateContainer.style.display = 'none';
          } finally {
            // Hide placeholder and show table after data is loaded
            document.getElementById('table-placeholder').style.display = 'none';
            isLoadingAssets = false;
          }
        }
        </script>
      </div>
    </div>
  </div>
</div>
{{ template "footer.html" . }}
