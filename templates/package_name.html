{{ template "header.html" . }}
<div class="bg-txlog-indigo -mt-4 pt-4 pb-6 mb-6 print:hidden">
  <div class="max-w-7xl mx-auto px-6 flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
    <h2 class="font-display font-bold text-2xl text-white">Package details</h2>
    <a class="inline-flex items-center gap-2 border-2 border-white/30 text-white text-sm font-medium px-4 py-2 rounded-xl hover:bg-white/10 transition-all"
      href="https://pkgs.org/search/?q={{ .name }}" target="_blank">
      Search for this package on pkgs.org
      <i data-lucide="external-link" class="w-4 h-4"></i>
    </a>
  </div>
</div>

<div class="max-w-7xl mx-auto px-6 pb-8 space-y-6">
  <div class="bg-white rounded-3xl shadow-soft overflow-hidden">
    <div class="border-b border-txlog-lavender px-6 py-4">
      <h3 class="font-display font-semibold text-lg">{{ .name }}</h3>
    </div>
    <div class="p-6">
      <div class="grid grid-cols-2 md:grid-cols-3 gap-6">
        <div>
          <div class="text-xs font-bold text-txlog-indigo/50 uppercase tracking-wider mb-1">Architecture</div>
          <div class="font-medium">
            {{ range $index, $arch := .archList }}{{- if $index }}, {{ end -}}{{ $arch }}{{- end }}
          </div>
        </div>
        <div>
          <div class="text-xs font-bold text-txlog-indigo/50 uppercase tracking-wider mb-1">Repository</div>
          <div class="font-medium">
            {{ range $index, $repo := .repoList }}{{- if $index }}, {{ end -}}{{ $repo }}{{- end }}
          </div>
        </div>
        <div>
          <div class="text-xs font-bold text-txlog-indigo/50 uppercase tracking-wider mb-1">Last seen</div>
          <div class="font-medium">
            {{ if .packages }}{{ formatDateTime (index .packages 0).LastSeen }}{{ end }}
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="grid md:grid-cols-2 gap-6">
    <div class="bg-white rounded-3xl shadow-soft overflow-hidden">
      <div class="border-b border-txlog-lavender px-6 py-4">
        <h3 class="font-display font-semibold text-lg">Version timeline</h3>
      </div>
      <div class="p-6">
        <div class="relative pl-8 space-y-6">
          <div class="absolute left-3 top-2 bottom-2 w-0.5 bg-txlog-lavender"></div>
          {{ range .packages }}
          <div class="relative">
            <div class="absolute -left-5 top-1 w-6 h-6 rounded-full bg-txlog-sky/10 flex items-center justify-center">
              <i data-lucide="package" class="w-3 h-3 text-txlog-sky"></i>
            </div>
            <div class="bg-txlog-bg rounded-2xl p-4 border border-txlog-lavender/30">
              <div class="flex items-start justify-between gap-3">
                <h4 class="font-semibold">{{ .Version }}<span class="text-txlog-indigo/50">-{{ .Release }}-{{ .Arch
                    }}</span></h4>
                <a href="javascript:loadPackageAssets('{{ $.name }}', '{{ .Version }}', '{{ .Release }}')"
                  class="text-txlog-sky hover:underline text-sm font-medium flex items-center gap-1">
                  List assets <i data-lucide="chevron-right" class="w-3.5 h-3.5"></i>
                </a>
              </div>
              <p class="text-sm text-txlog-indigo/60 mt-1">
                <strong>Repo:</strong> {{ .Repo }}<br />
                <strong>Last seen:</strong> {{ formatDateTime .LastSeen }}
              </p>
            </div>
          </div>
          {{ end }}
        </div>
      </div>
    </div>

    <div>
      <div id="table-placeholder" class="bg-white rounded-3xl shadow-soft p-6 hidden">
        <div class="space-y-3 animate-pulse">
          <div class="h-4 bg-txlog-lavender rounded w-3/4"></div>
          <div class="h-4 bg-txlog-lavender rounded w-1/2"></div>
          <div class="h-4 bg-txlog-lavender rounded w-2/3"></div>
          <div class="h-4 bg-txlog-lavender rounded w-1/3"></div>
        </div>
      </div>

      <div id="table-assets" class="bg-white rounded-3xl shadow-soft overflow-hidden hidden">
        <div class="border-b border-txlog-lavender px-6 py-4">
          <h3 class="font-display font-semibold text-lg">Assets running version <kbd id="version-display"
              class="bg-txlog-indigo/5 text-txlog-indigo text-xs font-mono px-2 py-1 rounded-md">loading...</kbd></h3>
        </div>
        <div id="assets-table-container">
          <div class="overflow-x-auto">
            <table class="w-full text-sm">
              <thead>
                <tr class="border-b border-txlog-lavender/50 text-left">
                  <th class="px-6 py-3 font-semibold text-txlog-indigo/70 text-xs uppercase tracking-wider">Hostname
                  </th>
                  <th class="px-6 py-3">&nbsp;</th>
                </tr>
              </thead>
              <tbody id="assets-table-body" class="divide-y divide-txlog-lavender/30">
              </tbody>
            </table>
          </div>
          <div class="border-t border-txlog-lavender/50 px-6 py-3 hidden" id="table-footer">
            <p class="text-sm text-txlog-indigo/50">Showing <strong id="entries-count">0</strong> entries</p>
          </div>
        </div>
        <div id="empty-state-container" class="hidden">
          <div class="py-12 text-center">
            <i data-lucide="package" class="w-12 h-12 text-txlog-indigo/20 mx-auto mb-4"></i>
            <p class="font-semibold mb-1">No assets found</p>
            <p class="text-sm text-txlog-indigo/50" id="empty-state-subtitle"></p>
          </div>
        </div>
      </div>

      <script>
        var isLoadingAssets = false;
        function loadPackageAssets(packageName, version, release) {
          if (isLoadingAssets) return;
          isLoadingAssets = true;
          var tableCard = document.getElementById('table-assets');
          var tableBody = document.getElementById('assets-table-body');
          var versionDisplay = document.getElementById('version-display');
          var entriesCount = document.getElementById('entries-count');
          var assetsTableContainer = document.getElementById('assets-table-container');
          var emptyStateContainer = document.getElementById('empty-state-container');
          var emptyStateSubtitle = document.getElementById('empty-state-subtitle');
          var displayVersion = version + '-' + release;
          versionDisplay.textContent = displayVersion;
          tableCard.classList.remove('hidden');
          assetsTableContainer.classList.add('hidden');
          emptyStateContainer.classList.add('hidden');
          document.getElementById('table-placeholder').classList.remove('hidden');
          fetch('/v1/packages/' + encodeURIComponent(packageName) + '/' + encodeURIComponent(version) + '/' + encodeURIComponent(release) + '/assets')
            .then(function (response) {
              if (!response.ok) throw new Error('HTTP error! status: ' + response.status);
              return response.json();
            })
            .then(function (assets) {
              tableBody.innerHTML = '';
              if (assets && assets.length > 0) {
                assets.forEach(function (asset) {
                  var row = document.createElement('tr');
                  row.className = 'hover:bg-txlog-lavender/10 transition-colors';
                  row.innerHTML = '<td class="px-6 py-3">' + (asset.hostname || 'Unknown') + '</td><td class="px-6 py-3 text-right"><a class="text-txlog-sky hover:underline text-sm font-medium" href="/assets/' + asset.machine_id + '">Details</a></td>';
                  tableBody.appendChild(row);
                });
                entriesCount.textContent = assets.length;
                document.getElementById('table-footer').classList.remove('hidden');
                assetsTableContainer.classList.remove('hidden');
                emptyStateContainer.classList.add('hidden');
              } else {
                emptyStateSubtitle.textContent = 'No assets are currently using version ' + displayVersion;
                assetsTableContainer.classList.add('hidden');
                emptyStateContainer.classList.remove('hidden');
              }
            })
            .catch(function (error) {
              if (error.message.indexOf('404') !== -1) {
                tableBody.innerHTML = '<tr><td colspan="2" class="px-6 py-4 text-center text-txlog-indigo/50">No assets found for this version</td></tr>';
              } else {
                tableBody.innerHTML = '<tr><td colspan="2" class="px-6 py-4 text-center text-txlog-coral">Error loading assets data</td></tr>';
              }
              assetsTableContainer.classList.remove('hidden');
              emptyStateContainer.classList.add('hidden');
            })
            .finally(function () {
              document.getElementById('table-placeholder').classList.add('hidden');
              isLoadingAssets = false;
            });
        }
      </script>
    </div>
  </div>
</div>
{{ template "footer.html" . }}
