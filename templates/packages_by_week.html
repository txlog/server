{{ template "header.html" . }}
<div class="bg-txlog-indigo -mt-4 pt-4 pb-6 mb-6 print:hidden">
  <div class="max-w-7xl mx-auto px-6">
    <h2 class="font-display font-bold text-2xl text-white">{{ .title }}</h2>
  </div>
</div>

<div class="max-w-7xl mx-auto px-6 pb-8 space-y-6">
  {{ if not .graphData }}
  <div class="bg-white rounded-3xl shadow-soft overflow-hidden">
    <div class="py-16 text-center">
      <i data-lucide="frown" class="w-12 h-12 text-txlog-indigo/20 mx-auto mb-4"></i>
      <p class="font-display font-semibold text-lg mb-2">No package progression data</p>
      <p class="text-sm text-txlog-indigo/50">Start by running <a href="https://txlog.rda.run/docs/agent"
          target="_blank" class="text-txlog-sky hover:underline">Txlog Agent</a> in one of your servers.</p>
    </div>
  </div>
  {{ else }}
  <div class="bg-white rounded-3xl shadow-soft overflow-hidden">
    <div class="p-6">
      <div class="flex flex-col md:flex-row gap-6">
        <div class="flex-1">
          <h3 class="font-display font-semibold text-lg mb-1">Package Progression by Week <span
              class="text-sm text-txlog-indigo/50 font-normal ml-1">last 3 months</span></h3>
          <div id="chart-active-users-2" style="min-height: 288px;"></div>
        </div>
        <div class="md:w-48 flex md:flex-col gap-6 md:gap-4 md:justify-center">
          <div class="px-4 py-3 bg-txlog-bg rounded-2xl">
            <div class="text-sm text-txlog-indigo/60 flex items-center gap-2"><span class="w-2 h-2 rounded-full"
                style="background-color: #D9556A;"></span> Installed</div>
            <div class="font-display font-bold text-2xl mt-1">
              {{ $total := 0 }}
              {{ range .graphData }}
              {{ $total = add $total .Install }}
              {{ end }}
              {{ formatInteger $total }}
            </div>
          </div>
          <div class="px-4 py-3 bg-txlog-bg rounded-2xl">
            <div class="text-sm text-txlog-indigo/60 flex items-center gap-2"><span class="w-2 h-2 rounded-full"
                style="background-color: #6AA2FB;"></span> Upgraded</div>
            <div class="font-display font-bold text-2xl mt-1">
              {{ $total := 0 }}
              {{ range .graphData }}
              {{ $total = add $total .Upgraded }}
              {{ end }}
              {{ formatInteger $total }}
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  {{ end }}

  {{ if .graphData }}
  <div class="bg-white rounded-3xl shadow-soft overflow-hidden">
    <div class="border-b border-txlog-lavender px-6 py-4">
      <h3 class="font-display font-semibold text-lg">Generate Management Report AI Prompt</h3>
    </div>
    <div class="p-6">
      <div class="grid md:grid-cols-3 gap-4">
        <div>
          <label class="font-medium text-sm pl-1 block mb-1.5">Select Month</label>
          <select id="report-month"
            class="w-full border-2 border-txlog-lavender bg-white/50 px-4 py-3 rounded-xl outline-none focus:border-txlog-sky focus:ring-4 focus:ring-txlog-sky/20 transition-all text-txlog-indigo font-medium">
            <option value="1">January</option>
            <option value="2">February</option>
            <option value="3">March</option>
            <option value="4">April</option>
            <option value="5">May</option>
            <option value="6">June</option>
            <option value="7">July</option>
            <option value="8">August</option>
            <option value="9">September</option>
            <option value="10">October</option>
            <option value="11">November</option>
            <option value="12">December</option>
          </select>
        </div>
        <div>
          <label class="font-medium text-sm pl-1 block mb-1.5">Select Year</label>
          <select id="report-year"
            class="w-full border-2 border-txlog-lavender bg-white/50 px-4 py-3 rounded-xl outline-none focus:border-txlog-sky focus:ring-4 focus:ring-txlog-sky/20 transition-all text-txlog-indigo font-medium">
          </select>
        </div>
        <div class="flex items-end">
          <button type="button" id="generate-report-btn"
            class="w-full bg-txlog-sky text-white font-medium py-3 rounded-xl hover:-translate-y-0.5 hover:shadow-lg hover:shadow-txlog-sky/30 transition-all flex items-center justify-center gap-2">
            <i data-lucide="file-text" class="w-4 h-4"></i>
            Generate Prompt
          </button>
        </div>
      </div>
    </div>
  </div>
  {{ end }}

  {{ if .graphData }}
  <div class="bg-white rounded-3xl shadow-soft overflow-hidden">
    <div class="overflow-x-auto">
      <table class="w-full text-sm">
        <thead>
          <tr class="border-b border-txlog-lavender/50 text-left">
            <th class="px-6 py-3 font-semibold text-txlog-indigo/70 text-xs uppercase tracking-wider">Week</th>
            <th class="px-6 py-3 font-semibold text-txlog-indigo/70 text-xs uppercase tracking-wider">Installed packages
            </th>
            <th class="px-6 py-3 font-semibold text-txlog-indigo/70 text-xs uppercase tracking-wider">Upgraded packages
            </th>
          </tr>
        </thead>
        <tbody class="divide-y divide-txlog-lavender/30">
          {{ range .graphData }}
          <tr class="hover:bg-txlog-lavender/10 transition-colors">
            <td class="px-6 py-3 font-medium">{{ formatDate .Week }}</td>
            <td class="px-6 py-3 whitespace-nowrap">{{ formatInteger .Install }}</td>
            <td class="px-6 py-3 whitespace-nowrap">{{ formatInteger .Upgraded }}</td>
          </tr>
          {{ end }}
        </tbody>
      </table>
    </div>
  </div>
  {{ end }}
</div>

<div id="prompt-modal" class="fixed inset-0 z-50 hidden items-center justify-center bg-black/50"
  onclick="if(event.target===this)closeModal('prompt-modal')">
  <div data-modal-panel
    class="bg-white rounded-3xl shadow-soft max-w-lg w-full mx-4 max-h-[80vh] flex flex-col transform transition-all scale-95 opacity-0">
    <div class="border-b border-txlog-lavender px-6 py-4 flex items-center justify-between flex-shrink-0">
      <h5 class="font-display font-semibold text-lg">Generated AI Report Prompt</h5>
      <button onclick="closeModal('prompt-modal')"
        class="text-txlog-indigo/40 hover:text-txlog-indigo transition-colors">
        <i data-lucide="x" class="w-5 h-5"></i>
      </button>
    </div>
    <div class="overflow-y-auto flex-1 p-6">
      <p class="text-sm text-txlog-indigo/60 mb-3">Copy the prompt below and paste it into any LLM (ChatGPT, Claude,
        Gemini, etc.) to generate your management report:</p>
      <textarea id="prompt-text" rows="12" readonly
        class="w-full border-2 border-txlog-lavender bg-txlog-bg px-4 py-3 rounded-xl font-mono text-sm outline-none text-txlog-indigo resize-none"></textarea>
    </div>
    <div class="border-t border-txlog-lavender px-6 py-4 flex gap-3 flex-shrink-0">
      <button onclick="closeModal('prompt-modal')"
        class="flex-1 border-2 border-txlog-lavender text-txlog-indigo font-medium py-2.5 rounded-xl hover:bg-txlog-lavender/20 transition-all">Close</button>
      <button id="copy-prompt-btn"
        class="flex-1 bg-txlog-sky text-white font-medium py-2.5 rounded-xl hover:-translate-y-0.5 hover:shadow-lg hover:shadow-txlog-sky/30 transition-all flex items-center justify-center gap-2">
        <i data-lucide="copy" class="w-4 h-4"></i> Copy to Clipboard
      </button>
    </div>
  </div>
</div>

<div id="error-modal" class="fixed inset-0 z-50 hidden items-center justify-center bg-black/50"
  onclick="if(event.target===this)closeModal('error-modal')">
  <div data-modal-panel
    class="bg-white rounded-3xl shadow-soft max-w-sm w-full mx-4 transform transition-all scale-95 opacity-0">
    <div class="h-1 bg-txlog-coral rounded-t-3xl"></div>
    <div class="p-6 text-center">
      <i data-lucide="triangle-alert" class="w-12 h-12 text-txlog-coral mx-auto mb-3"></i>
      <h3 class="font-display font-semibold text-lg mb-2">No Data Available</h3>
      <p class="text-sm text-txlog-indigo/60" id="error-modal-message"></p>
    </div>
    <div class="border-t border-txlog-lavender px-6 py-4">
      <button onclick="closeModal('error-modal')"
        class="w-full border-2 border-txlog-lavender text-txlog-indigo font-medium py-2.5 rounded-xl hover:bg-txlog-lavender/20 transition-all">Close</button>
    </div>
  </div>
</div>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    window.ApexCharts &&
      new ApexCharts(document.getElementById("chart-active-users-2"), {
        chart: {
          type: "line", fontFamily: "Inter, sans-serif", height: 288, parentHeightOffset: 0,
          toolbar: { show: false }, animations: { enabled: false },
        },
        stroke: { width: 2, lineCap: "round", curve: "smooth" },
        series: [
          { name: "Installed", data: [{{ range .graphData }}{{ .Install }}, {{ end }}] },
    { name: "Upgraded", data: [{{ range .graphData }}{{ .Upgraded }}, {{ end }}] },
        ],
    tooltip: { theme: "dark" },
    grid: { padding: { top: -20, right: 0, left: -4, bottom: -4 }, strokeDashArray: 4 },
    xaxis: { labels: { padding: 0 }, tooltip: { enabled: false }, type: "string" },
    yaxis: { labels: { padding: 4 } },
    labels: [{{ range .graphData }}"{{ formatDate .Week }}", {{ end }}],
    colors: ['#D9556A', '#6AA2FB'],
    legend: { show: false },
      }).render();

  var yearSelect = document.getElementById('report-year');
  var currentYear = new Date().getFullYear();
  for (var year = currentYear; year >= currentYear - 5; year--) {
    var option = document.createElement('option');
    option.value = year;
    option.textContent = year;
    yearSelect.appendChild(option);
  }
  document.getElementById('report-month').value = new Date().getMonth() + 1;

  document.getElementById('generate-report-btn').addEventListener('click', function () {
    var month = document.getElementById('report-month').value;
    var year = document.getElementById('report-year').value;
    var btn = this;
    btn.disabled = true;
    btn.innerHTML = '<svg class="animate-spin w-4 h-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path></svg> Loading...';

    fetch('/api/packages-by-month?month=' + month + '&year=' + year)
      .then(function (response) {
        if (!response.ok) throw new Error('Failed to fetch data');
        return response.json();
      })
      .then(function (data) {
        var csvContent = data.csv_content;
        var assetCount = data.asset_count;
        var csvLines = csvContent.trim().split('\n');
        if (csvLines.length <= 1) throw new Error('No package updates found for the selected period (' + getMonthName(month) + ' ' + year + ').');
        var monthName = getMonthName(month);
        var prompt = 'Act as an SRE specialist preparing an executive summary for management. The tone should be professional, direct, and focused on impact and security. Format the final response in Markdown.\n\nReport Period: ' + monthName + ' ' + year + '\n\nContext: Below is the list of packages that were updated in our infrastructure during the reporting period. The data shows the number of servers where each package was updated, and the total number of update transactions (some servers may receive the same package update multiple times). Our total infrastructure consists of ' + assetCount + ' servers.\n\nData:\n---\n' + csvContent + '\n---\n\nTask:\nBased on this data, write a brief management report in Markdown format (1-2 paragraphs) highlighting:\n1. The most critical and high-impact updates, considering the number of affected servers. Give special attention to security packages (such as OpenSSL) or system packages (such as the Kernel).\n2. The overall reach of the updates (percentage of servers impacted by the most important updates).\n3. Any relevant patterns or observations that management should be aware of.\n4. Research on the internet which CVEs these packages may have fixed during the selected period, always summarizing each CVE in one or two sentences. Use Red Hat Enterprise Linux errata as a reference, since RPM-based systems are based on RHEL.';
        document.getElementById('prompt-text').value = prompt;
        openModal('prompt-modal');
        lucide.createIcons();
      })
      .catch(function (error) {
        document.getElementById('error-modal-message').textContent = error.message;
        openModal('error-modal');
        lucide.createIcons();
      })
      .finally(function () {
        btn.disabled = false;
        btn.innerHTML = '<i data-lucide="file-text" class="w-4 h-4"></i> Generate Prompt';
        lucide.createIcons();
      });
  });

  document.getElementById('copy-prompt-btn').addEventListener('click', function () {
    var promptText = document.getElementById('prompt-text');
    var copyBtn = this;
    navigator.clipboard.writeText(promptText.value).then(function () {
      copyBtn.innerHTML = '<i data-lucide="check" class="w-4 h-4"></i> Copied!';
      lucide.createIcons();
      setTimeout(function () {
        copyBtn.innerHTML = '<i data-lucide="copy" class="w-4 h-4"></i> Copy to Clipboard';
        lucide.createIcons();
      }, 2000);
    }).catch(function () {
      alert('Failed to copy to clipboard');
    });
  });
  });

  function getMonthName(monthNumber) {
    var months = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
    return months[monthNumber - 1];
  }
</script>

{{ template "footer.html" . }}
